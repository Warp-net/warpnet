#!/bin/bash

set -euo pipefail

if [ "$(git rev-parse --abbrev-ref HEAD)" = "main" ]; then
    exit 0
fi

echo "Pre-commit hook started..."

CONFIG="version"
SNAPCRAFT="snap/snapcraft.yaml"

if [ ! -f "$CONFIG" ]; then
    echo "Config file not found!"
    exit 1
fi

if [ ! -f "$SNAPCRAFT" ]; then
    echo "Snapcraft file not found: $SNAPCRAFT"
    exit 1
fi

CURRENT_VERSION=$(grep -Eo '^[0-9]+\.[0-9]+\.[0-9]+' "$CONFIG")
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$PATCH"

sed -i "s/^$CURRENT_VERSION\$/$NEW_VERSION/" "$CONFIG"
sed -i "s/version: ${CURRENT_VERSION}/version: ${NEW_VERSION}/" "$SNAPCRAFT"

git add "$CONFIG" "$SNAPCRAFT"


